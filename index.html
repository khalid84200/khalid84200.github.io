<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GMAO Pro X</title>
    <meta name="theme-color" content="#4A90E2"/>
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/maintenance.png">
    <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;GMAO Pro X&quot;,&quot;short_name&quot;:&quot;GMAO&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#F4F7FC&quot;,&quot;theme_color&quot;:&quot;#4A90E2&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;https://img.icons8.com/fluency/96/maintenance.png&quot;,&quot;sizes&quot;:&quot;96x96&quot;,&quot;type&quot;:&quot;image/png&quot;}]}">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <script type="module">
        const firebaseConfig = {
          apiKey: "AIzaSyBQCBlzr-RTDb99gF3sqhvbNIGXcf6OWEg",
          authDomain: "ma-gmao-ca6a5.firebaseapp.com",
          projectId: "ma-gmao-ca6a5",
          storageBucket: "ma-gmao-ca6a5.appspot.com",
          messagingSenderId: "279000639370",
          appId: "1:279000639370:web:6c04f86ba8dc82d097ca73"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        window.db = getFirestore(initializeApp(firebaseConfig));
        window.auth = getAuth();
        window.firebase = {
            collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, writeBatch, runTransaction,
            onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
        };

        document.addEventListener('DOMContentLoaded', () => GMAOApp.init());
    </script>

    <style>
        :root { --primary-color: #4A90E2; --secondary-color: #50E3C2; --danger-color: #D0021B; --warning-color: #F5A623; --light-bg: #F4F7FC; --white: #FFFFFF; --dark-gray: #4A4A4A; --light-gray: #9B9B9B; --border-color: #EAEAEA; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --header-height: 60px; --nav-height: 65px; }
        body.dark-mode { --light-bg: #1a1a1a; --white: #2c2c2c; --dark-gray: #F4F7FC; --light-gray: #a0a0a0; --border-color: #3a3a3a; --shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--light-bg); color: var(--dark-gray); padding-bottom: var(--nav-height); transition: background-color 0.3s, color 0.3s; }
        .page-container { padding: 15px; padding-top: calc(var(--header-height) + 15px); }
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); background-color: var(--white); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; transition: background-color 0.3s; }
        .app-header h1 { font-size: 22px; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .header-actions i { font-size: 20px; cursor: pointer; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background-color: var(--white); display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; transition: background-color 0.3s; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--light-gray); text-decoration: none; flex-grow: 1; transition: color 0.2s; font-size: 10px; text-align: center; position: relative; }
        .nav-item i { font-size: 20px; } .nav-item span { margin-top: 5px; } .nav-item.active { color: var(--primary-color); }
        .notification-dot { position: absolute; top: 2px; right: 15px; width: 8px; height: 8px; background-color: var(--danger-color); border-radius: 50%; display: none; }
        .page-content { display: none; } .page-content.active { display: block; animation: fadeIn 0.4s; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: var(--white); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); transition: background-color 0.3s, transform 0.2s; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .btn { display: inline-block; padding: 12px 20px; border-radius: 8px; border: none; background-color: var(--primary-color); color: #FFF; font-weight: 600; cursor: pointer; text-align: center; transition: background-color 0.2s, transform 0.2s; font-size: 16px; }
        .btn:disabled { background-color: var(--light-gray); cursor: not-allowed; }
        .btn:active { transform: scale(0.97); } .btn-full { width: 100%; } .btn-danger { background-color: var(--danger-color); }
        .fab { position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px; width: 56px; height: 56px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 6px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 999; }
        .search-bar { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; background-color: var(--light-bg); color: var(--dark-gray); font-size: 16px; }
        .item-list { list-style: none; } .list-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); } .list-item-clickable { cursor: pointer; } .list-item:last-child { border-bottom: none; }
        .item-icon { width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; margin-right: 15px; flex-shrink: 0; }
        .bg-blue { background-color: #4A90E2; } .bg-green { background-color: #7ED321; } .bg-orange { background-color: #F5A623; } .bg-purple { background-color: #9013FE; } .bg-grey { background-color: #9B9B9B; }
        .item-info { flex-grow: 1; } .item-title { font-weight: 600; font-size: 16px; } .item-subtitle { font-size: 14px; color: var(--light-gray); }
        .item-details { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .detail-badge { background-color: var(--light-bg); color: var(--dark-gray); padding: 4px 8px; border-radius: 6px; font-size: 12px; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; color: #fff; }
        .status-planned { background-color: var(--primary-color); } .status-progress { background-color: var(--warning-color); } .status-completed { background-color: var(--secondary-color); } .status-low-stock { background-color: var(--warning-color); }
        .status-info { background-color: var(--light-gray); color: var(--dark-gray); }
        .item-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; } 
        .item-actions i { font-size: 18px; color: var(--light-gray); cursor: pointer; transition: color 0.2s; } 
        .item-actions i:hover { color: var(--primary-color); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: auto; } .modal-content { background-color: var(--white); padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s; }
        .modal.active .modal-content { transform: scale(1); } .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 600; } .close-modal { font-size: 24px; cursor: pointer; color: var(--light-gray); }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; background-color: var(--light-bg); color: var(--dark-gray); }
        .loading-message { text-align: center; padding: 40px; color: var(--light-gray); }
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--light-bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-box { width: 90%; max-width: 350px; padding: 30px; background-color: var(--white); border-radius: 15px; box-shadow: var(--shadow); text-align: center; }
        .auth-box h2 { margin-bottom: 20px; color: var(--primary-color); }
        .auth-error { color: var(--danger-color); margin-top: 10px; font-size: 14px; height: 20px; }
        .auth-toggle-link { margin-top: 15px; font-size: 14px; color: var(--primary-color); cursor: pointer; }
        #signup-form { display: none; }
        .app-container { display: none; }
        .parts-search-results { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 5px; }
        .parts-search-results div { padding: 10px; cursor: pointer; }
        .parts-search-results div:hover { background-color: var(--light-bg); }
        .used-part-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .used-part-item span { flex-grow: 1; }
        .used-part-item input { width: 60px; }
        .used-part-item button { background: none; border: none; color: var(--danger-color); font-size: 18px; cursor: pointer; }
        .filter-toggle { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .chart-container { max-height: 250px; position: relative; }
        .kpi-grid-pro { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; }
        .kpi-gauge-container { position: relative; width: 120px; height: 120px; margin: 0 auto; }
        .kpi-gauge-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; }
        .kpi-column { text-align: center; }
        .kpi-column .kpi-value { font-size: 22px; font-weight: 700; }
        .kpi-column .kpi-label { font-size: 12px; color: var(--light-gray); }
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .detail-table th, .detail-table td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border-color); }
        .detail-table th { font-size: 12px; color: var(--light-gray); }
    </style>
</head>
<body>
    <div id="auth-container">
        <div class="auth-box">
            <form id="login-form">
                <h2><i class="fas fa-lock"></i> Connexion</h2>
                <div class="form-group"><input type="email" id="login-email" class="form-control" placeholder="Email" required></div>
                <div class="form-group"><input type="password" id="login-password" class="form-control" placeholder="Mot de passe" required></div>
                <button type="submit" class="btn btn-full">Se connecter</button>
                <p class="auth-error" id="login-error-msg"></p>
                <p class="auth-toggle-link" id="show-signup">Pas de compte ? S'inscrire</p>
            </form>
            <form id="signup-form">
                <h2><i class="fas fa-user-plus"></i> Inscription</h2>
                <div class="form-group"><input type="email" id="signup-email" class="form-control" placeholder="Email" required></div>
                <div class="form-group"><input type="password" id="signup-password" class="form-control" placeholder="Mot de passe (6+ caractères)" required></div>
                <button type="submit" class="btn btn-full">Créer un compte</button>
                <p class="auth-error" id="signup-error-msg"></p>
                <p class="auth-toggle-link" id="show-login">Déjà un compte ? Se connecter</p>
            </form>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header">
            <h1><i class="fas fa-tools"></i> GMAO Pro X</h1>
            <div class="header-actions">
                <i class="fas fa-moon theme-switcher"></i>
                <i class="fab fa-whatsapp" id="whatsapp-btn" title="Communauté"></i>
                <i class="fas fa-sign-out-alt" id="logout-btn" title="Déconnexion"></i>
            </div>
        </header>
        <main class="page-container">
            <div class="page-content active" id="dashboard">
                <div class="card" id="test-data-card" style="display: none;">
                    <div class="section-title"><i class="fas fa-database"></i> Base de données vide</div>
                    <p style="color: var(--light-gray); margin-bottom: 15px;">Cliquez pour ajouter des données de démo.</p>
                    <button id="add-test-data-btn" class="btn btn-full">Ajouter Données de Test</button>
                </div>
                <div class="card">
                    <div class="section-title"><i class="fas fa-filter"></i> Filtrer</div>
                    <div class="date-filter-grid">
                        <div class="form-group" style="margin:0;"><label for="date-start">Début</label><input type="date" id="date-start" class="form-control"></div>
                        <div class="form-group" style="margin:0;"><label for="date-end">Fin</label><input type="date" id="date-end" class="form-control"></div>
                        <button id="filter-btn" class="btn"><i class="fas fa-check"></i> Appliquer</button>
                    </div>
                </div>
                <div class="card">
                    <div class="section-title"><i class="fas fa-tachometer-alt"></i> KPI</div>
                    <div class="kpi-grid-pro">
                        <div class="kpi-gauge-container">
                            <canvas id="availabilityChart"></canvas>
                            <div id="kpi-availability-value" class="kpi-gauge-value">--%</div>
                        </div>
                        <div class="kpi-column">
                            <div class="kpi-value" id="kpi-mttr">--</div>
                            <div class="kpi-label">MTTR</div>
                            <hr style="margin: 10px 0; border-color: var(--border-color);">
                            <div class="kpi-value" id="kpi-mtbf">--</div>
                            <div class="kpi-label">MTBF</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="section-title"><i class="fas fa-chart-bar"></i> Top 3 Machines - Temps d'arrêt (h)</div>
                    <canvas id="downtimeByMachineChart"></canvas>
                </div>
                <div class="card">
                    <div class="section-title"><i class="fas fa-history"></i> Interventions récentes</div>
                    <ul class="item-list" id="recent-interventions-list"><div class="loading-message">Chargement...</div></ul>
                </div>
            </div>
            <div class="page-content" id="equipments">
                <input type="text" class="search-bar" id="equipment-search" placeholder="Rechercher...">
                <ul class="item-list" id="equipments-list"><div class="loading-message">Chargement...</div></ul>
            </div>
            <div class="page-content" id="interventions">
                <input type="text" class="search-bar" id="intervention-search" placeholder="Rechercher par OT ou description...">
                 <div class="card">
                    <div class="section-title"><i class="fas fa-filter"></i> Filtrer les Interventions</div>
                    <div class="date-filter-grid">
                        <div class="form-group" style="margin:0;"><label for="intervention-date-start">Début</label><input type="date" id="intervention-date-start" class="form-control"></div>
                        <div class="form-group" style="margin:0;"><label for="intervention-date-end">Fin</label><input type="date" id="intervention-date-end" class="form-control"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="section-title"><i class="fas fa-chart-pie"></i> Ratio Préventif / Correctif</div>
                    <div class="chart-container"><canvas id="ratioChartCanvas"></canvas></div>
                </div>
                <ul class="item-list" id="interventions-list"><div class="loading-message">Chargement...</div></ul>
            </div>
            <div class="page-content" id="parts">
                <input type="text" class="search-bar" id="part-search" placeholder="Rechercher...">
                <div class="card">
                    <div class="section-title"><i class="fas fa-dollar-sign"></i> Valeur du Stock</div>
                    <h3 id="total-stock-value" style="text-align: center; color: var(--primary-color);">Calcul...</h3>
                </div>
                <div class="card">
                    <div class="section-title"><i class="fas fa-filter"></i> Filtrer les Pièces</div>
                    <div class="form-group">
                        <label for="supplier-filter">Fournisseur</label>
                        <select id="supplier-filter" class="form-control"></select>
                    </div>
                    <div class="filter-toggle">
                        <input type="checkbox" id="reorder-filter">
                        <label for="reorder-filter">Afficher les articles à commander</label>
                    </div>
                </div>
                <ul class="item-list" id="parts-list"><div class="loading-message">Chargement...</div></ul>
            </div>
            <div class="page-content" id="technicians">
                <input type="text" class="search-bar" id="technician-search" placeholder="Rechercher...">
                <ul class="item-list" id="technicians-list"><div class="loading-message">Chargement...</div></ul>
            </div>
        </main>
        <div class="fab" id="fab-add-button"><i class="fas fa-plus"></i></div>
        <nav class="bottom-nav"><a href="#dashboard" class="nav-item active"><i class="fas fa-home"></i><span>Accueil</span></a><a href="#equipments" class="nav-item"><i class="fas fa-cogs"></i><span>Équipements</span></a><a href="#interventions" class="nav-item"><i class="fas fa-wrench"></i><span>Interventions</span></a><a href="#parts" class="nav-item"><i class="fas fa-box-open"></i><span>Pièces</span><span class="notification-dot"></span></a><a href="#technicians" class="nav-item"><i class="fas fa-users"></i><span>Techniciens</span></a></nav>
        <div class="modal" id="formModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="modalTitle">Nouveau</h3><span class="close-modal">&times;</span></div><form id="mainForm"></form></div></div>
        <div class="modal" id="qrModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">QR Code</h3><span class="close-modal">&times;</span></div><div id="qrCodeContainer" style="text-align: center;"><p id="qrEquipmentName" style="margin-bottom: 15px; font-weight: 500;"></p><div id="qrCodeCanvas"></div></div></div></div>
        <div class="modal" id="statsModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="statsModalTitle">Statistiques</h3><span class="close-modal">&times;</span></div><div class="stats-modal-grid"><div class="stats-item"><div class="value" id="statsTotalTime">--</div><div class="label">Temps total en intervention</div></div><div class="stats-item"><div class="value" id="statsWorkload">--</div><div class="label">Charge de travail</div></div></div></div></div>
        <div class="modal" id="equipmentDetailModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="equipmentDetailModalTitle">Détails</h3><span class="close-modal">&times;</span></div><div id="equipmentDetailContent"></div></div></div>
        <div class="modal" id="partDetailModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="partDetailModalTitle">Détails de la pièce</h3><span class="close-modal">&times;</span></div><div id="partDetailContent"></div></div></div>
        <div class="modal" id="whatsappModal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Rejoindre la communauté</h3><span class="close-modal">&times;</span></div><div style="text-align: center; display: flex; flex-direction: column; gap: 15px;"><a href="https://chat.whatsapp.com/BNWATqvGwSIJ5a5jIZE80H" target="_blank" class="btn btn-full" style="background-color: #25D366;"><i class="fab fa-whatsapp"></i> Rejoindre le Groupe</a><a href="https://whatsapp.com/channel/0029Vb6TLcqEFeXjfGXHAe2v" target="_blank" class="btn btn-full" style="background-color: #25D366;"><i class="fas fa-bullhorn"></i> Suivre la Chaîne</a></div></div></div>
    </div>

<script type="module">
const GMAOApp = {
    data: { equipments: [], technicians: [], interventions: [], parts: [] },
    dashboardFilters: { startDate: null, endDate: null },
    charts: {},
    currentUser: null,
    unsubscribeListeners: [],

    init() {
        this.setupAuthUi();
        this.applyTheme(localStorage.getItem('gmao-theme') || 'light');
    },

    setupAuthUi() {
        const { onAuthStateChanged } = window.firebase;
        onAuthStateChanged(window.auth, user => {
            if (user) {
                this.currentUser = user;
                this.startApp();
            } else {
                this.currentUser = null;
                this.showLoginScreen();
            }
        });

        document.getElementById('login-form').addEventListener('submit', e => this.handleLogin(e));
        document.getElementById('signup-form').addEventListener('submit', e => this.handleSignup(e));
        document.getElementById('show-signup').addEventListener('click', () => { document.getElementById('login-form').style.display = 'none'; document.getElementById('signup-form').style.display = 'block'; });
        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('signup-form').style.display = 'none'; document.getElementById('login-form').style.display = 'block'; });
    },

    async handleLogin(e) {
        e.preventDefault();
        const { signInWithEmailAndPassword } = window.firebase;
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorMsg = document.getElementById('login-error-msg');
        const button = e.target.querySelector('button');
        
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        errorMsg.textContent = '';

        try { await signInWithEmailAndPassword(window.auth, email, password); } 
        catch (error) {
            errorMsg.textContent = "Email ou mot de passe incorrect.";
            button.disabled = false;
            button.textContent = 'Se connecter';
        }
    },

    async handleSignup(e) {
        e.preventDefault();
        const { createUserWithEmailAndPassword } = window.firebase;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const errorMsg = document.getElementById('signup-error-msg');
        const button = e.target.querySelector('button');

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        errorMsg.textContent = '';

        try { await createUserWithEmailAndPassword(window.auth, email, password); } 
        catch (error) {
            errorMsg.textContent = "Erreur : mot de passe trop court ou email invalide.";
            button.disabled = false;
            button.textContent = 'Créer un compte';
        }
    },

    showLoginScreen() {
        document.querySelector('.app-container').style.display = 'none';
        document.getElementById('auth-container').style.display = 'flex';
        this.unsubscribeListeners.forEach(unsub => unsub());
        this.unsubscribeListeners = [];
    },

    startApp() {
        document.getElementById('auth-container').style.display = 'none';
        document.querySelector('.app-container').style.display = 'block';
        this.setupEventListeners();
        this.attachRealtimeListeners();
    },

    attachRealtimeListeners() {
        const { collection, onSnapshot } = window.firebase;
        if (!this.currentUser) return;
        
        this.unsubscribeListeners.forEach(unsub => unsub());
        this.unsubscribeListeners = [];

        const collections = ['equipments', 'technicians', 'interventions', 'parts'];
        const basePath = `users/${this.currentUser.uid}`;
        
        collections.forEach(colName => {
            const unsub = onSnapshot(collection(window.db, basePath, colName), (snapshot) => {
                this.data[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.renderCurrentPage();
            });
            this.unsubscribeListeners.push(unsub);
        });
        this.navigateTo(window.location.hash || '#dashboard');
    },

    renderCurrentPage() {
        const hash = window.location.hash || '#dashboard';
        this.updateLowStockNotification();
        
        document.getElementById('whatsapp-btn').style.display = (hash === '#dashboard') ? 'block' : 'none';
        document.getElementById('fab-add-button').style.display = (hash === '#dashboard') ? 'none' : 'flex';

        switch (hash) {
            case '#dashboard': this.renderDashboard(); break;
            case '#equipments': this.renderListPage('equipments'); break;
            case '#interventions': this.renderInterventionsPage(); break;
            case '#parts': this.renderPartsPage(); break;
            case '#technicians': this.renderListPage('technicians'); break;
        }
    },
    
    async handleSubmit(event) {
        event.preventDefault();
        const { doc, addDoc, setDoc, collection, runTransaction } = window.firebase;
        const form = event.target;
        const type = form.dataset.type;
        const formData = new FormData(form);
        const id = formData.get('id');
        let itemData = Object.fromEntries(formData.entries());
        
        const newPartsUsed = {};
        if (type === 'interventions') {
            form.querySelectorAll('.used-part-item').forEach(item => {
                const partId = item.dataset.partId;
                const qtyInput = item.querySelector('input');
                const qty = parseInt(qtyInput.value, 10);
                if (qty > 0) {
                    newPartsUsed[partId] = qty;
                }
            });
            itemData.partsUsed = newPartsUsed;
        }

        delete itemData.id;
        
        const path = `users/${this.currentUser.uid}/${type}`;

        try {
            if (type === 'parts' && !id && itemData.reference) {
                const existingPart = this.data.parts.find(p => p.reference && p.reference.toLowerCase() === itemData.reference.toLowerCase());
                if (existingPart) {
                    alert("Erreur : Une pièce avec cette référence existe déjà.");
                    return;
                }
            }

            if (type === 'interventions') {
                await runTransaction(window.db, async (transaction) => {
                    const oldIntervention = id ? this.data.interventions.find(i => i.id === id) : null;
                    const oldPartsUsed = oldIntervention?.partsUsed || {};
                    const wasCompleted = oldIntervention?.status === 'completed';
                    const isNowCompleted = itemData.status === 'completed';

                    const stockChanges = {};
                    const allPartIds = new Set([...Object.keys(oldPartsUsed), ...Object.keys(newPartsUsed)]);

                    for (const partId of allPartIds) {
                        const oldQty = wasCompleted ? (oldPartsUsed[partId] || 0) : 0;
                        const newQty = isNowCompleted ? (newPartsUsed[partId] || 0) : 0;
                        const change = oldQty - newQty;
                        if (change !== 0) {
                            const partRef = doc(window.db, `users/${this.currentUser.uid}/parts`, partId);
                            const partDoc = await transaction.get(partRef);
                            if (partDoc.exists()) {
                                const currentQuantity = Number(partDoc.data().quantity);
                                if (currentQuantity + change < 0) {
                                    throw `Stock insuffisant pour ${partDoc.data().name}. Stock actuel: ${currentQuantity}, requis: ${-change}.`;
                                }
                                transaction.update(partRef, { quantity: currentQuantity + change });
                            }
                        }
                    }

                    if (id) {
                        const interventionRef = doc(window.db, path, id);
                        transaction.set(interventionRef, itemData, { merge: true });
                    } else {
                        itemData.otNumber = `OT-${Date.now()}`;
                        const newInterventionRef = doc(collection(window.db, path));
                        transaction.set(newInterventionRef, itemData);
                    }
                });
            } else {
                if (id) {
                    await setDoc(doc(window.db, path, id), itemData, { merge: true });
                } else {
                    await addDoc(collection(window.db, path), itemData);
                }
            }
            this.closeModal('formModal');
        } catch (e) { console.error("Erreur Firestore: ", e); alert(e); }
    },

    async deleteItem(type, id) {
        if (!confirm('Voulez-vous vraiment supprimer cet élément ?')) return;
        const { doc, deleteDoc } = window.firebase;
        const path = `users/${this.currentUser.uid}/${type}/${id}`;
        try { await deleteDoc(doc(window.db, path)); this.closeModal('formModal'); } 
        catch (e) { console.error("Erreur Firestore: ", e); alert("Une erreur est survenue."); }
    },

    getFilteredInterventions(filters) {
        const { startDate, endDate } = filters;
        if (!startDate && !endDate) return this.data.interventions;
        return this.data.interventions.filter(i => {
            const iDate = new Date(i.date);
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            if (start && iDate < start) return false;
            if (end) { end.setHours(23, 59, 59, 999); if (iDate > end) return false; }
            return true;
        });
    },

    renderDashboard() {
        document.getElementById('add-test-data-btn').addEventListener('click', () => this.addTestData());
        document.getElementById('date-start').value = this.dashboardFilters.startDate;
        document.getElementById('date-end').value = this.dashboardFilters.endDate;
        document.getElementById('filter-btn').addEventListener('click', () => { this.dashboardFilters.startDate = document.getElementById('date-start').value; this.dashboardFilters.endDate = document.getElementById('date-end').value; this.renderDashboard(); });

        if (this.data.interventions.length === 0 && this.data.equipments.length === 0) {
            document.getElementById('test-data-card').style.display = 'block';
        } else {
             document.getElementById('test-data-card').style.display = 'none';
        }

        const filteredInterventions = this.getFilteredInterventions(this.dashboardFilters);
        const recentList = document.getElementById('recent-interventions-list');
        const sorted = [...filteredInterventions].sort((a,b) => new Date(b.date) - new Date(a.date));
        recentList.innerHTML = sorted.length ? sorted.slice(0, 3).map(item => this.getItemTemplate('interventions', item)).join('') : `<div class="loading-message">Aucune intervention récente.</div>`;
        const correctiveCompleted = filteredInterventions.filter(i => i.type === 'Corrective' && i.status === 'completed' && i.downtimeStart && i.downtimeEnd).sort((a, b) => new Date(a.downtimeStart) - new Date(b.downtimeStart));
        this.calculateAndDisplayKPIs(correctiveCompleted);
        this.renderAnalysisCharts(filteredInterventions);
    },

    renderListPage(type) {
        const searchTerm = document.getElementById(`${type.slice(0, -1)}-search`).value;
        this.renderList(type, this.data[type], searchTerm);
    },

    renderInterventionsPage() {
        ['intervention-date-start', 'intervention-date-end'].forEach(id => { document.getElementById(id).addEventListener('input', () => this.renderInterventionsPage()); });
        document.getElementById('intervention-search').addEventListener('input', () => this.renderInterventionsPage());

        const startDate = document.getElementById('intervention-date-start').value;
        const endDate = document.getElementById('intervention-date-end').value;
        const searchTerm = document.getElementById('intervention-search').value.toLowerCase();
        const filteredByDate = this.getFilteredInterventions({ startDate, endDate });
        const filteredBySearch = filteredByDate.filter(item => (item.desc.toLowerCase().includes(searchTerm)) || (item.otNumber && item.otNumber.toLowerCase().includes(searchTerm)));
        this.renderList('interventions', filteredBySearch, '');
        const typeCounts = filteredByDate.reduce((acc, item) => { if (item.type) acc[item.type] = (acc[item.type] || 0) + 1; return acc; }, {});
        this.createChart('ratioChartCanvas', 'doughnut', { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#4A90E2', '#F5A623', '#50E3C2'] }] }, { plugins: { legend: { position: 'top' } } });
    },

    renderPartsPage() {
        const supplierFilter = document.getElementById('supplier-filter');
        const reorderFilter = document.getElementById('reorder-filter');
        const searchInput = document.getElementById('part-search');
        const totalStockValueEl = document.getElementById('total-stock-value');

        const suppliers = [...new Set(this.data.parts.map(p => p.supplier))].filter(Boolean);
        supplierFilter.innerHTML = `<option value="">Tous les fournisseurs</option>` + suppliers.map(s => `<option value="${s}">${s}</option>`).join('');

        const totalValue = this.data.parts.reduce((total, part) => {
            return total + (Number(part.quantity) * Number(part.unitPrice || 0));
        }, 0);
        totalStockValueEl.textContent = `${totalValue.toFixed(2)} Dhs.`;

        const applyFilters = () => {
            const selectedSupplier = supplierFilter.value;
            const needsReorder = reorderFilter.checked;
            const searchTerm = searchInput.value.toLowerCase();

            let filteredParts = this.data.parts;

            if (selectedSupplier) {
                filteredParts = filteredParts.filter(p => p.supplier === selectedSupplier);
            }
            if (needsReorder) {
                filteredParts = filteredParts.filter(p => Number(p.quantity) <= Number(p.minQuantity));
            }
            if (searchTerm) {
                filteredParts = filteredParts.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.reference && p.reference.toLowerCase().includes(searchTerm)));
            }
            this.renderList('parts', filteredParts, '');
        };

        supplierFilter.onchange = applyFilters;
        reorderFilter.onchange = applyFilters;
        searchInput.oninput = applyFilters;
        applyFilters();
    },

    renderList(type, data, searchTerm = '') {
        const listElement = document.getElementById(`${type}-list`);
        if (!listElement) return;
        const filteredData = searchTerm ? data.filter(item => (item.name && item.name.toLowerCase().includes(searchTerm)) || (item.desc && item.desc.toLowerCase().includes(searchTerm)) || (item.reference && item.reference.toLowerCase().includes(searchTerm)) || (item.otNumber && item.otNumber.toLowerCase().includes(searchTerm))) : data;
        listElement.innerHTML = filteredData.length > 0 ? filteredData.map(item => this.getItemTemplate(type, item)).join('') : `<div class="loading-message">Aucun élément trouvé.</div>`;
    },

    getItemTemplate(type, item) {
        let icon, title, subtitle, actions = '', details = '', clickableClass = 'list-item-clickable';
        switch (type) {
            case 'equipments':
                icon = `<div class="item-icon bg-blue"><i class="fas fa-cogs"></i></div>`;
                title = item.name; subtitle = item.location;
                actions = `<i class="fas fa-edit" onclick="event.stopPropagation(); GMAOApp.openForm('equipments', '${item.id}')"></i><i class="fas fa-qrcode" onclick="event.stopPropagation(); GMAOApp.showQRCode('${item.id}')"></i>`;
                break;
            case 'interventions':
                const eq = this.data.equipments.find(e => e.id === item.eqId);
                icon = `<div class="item-icon bg-orange"><i class="fas fa-wrench"></i></div>`;
                title = `${item.otNumber || ''}: ${item.desc}`; 
                subtitle = `${eq ? eq.name : 'N/A'} - ${item.date ? new Date(item.date).toLocaleDateString() : ''}`;
                const statusClasses = { planned: 'status-planned', progress: 'status-progress', completed: 'status-completed' };
                actions = `<span class="status-badge ${statusClasses[item.status]}">${item.status}</span>`;
                if (item.downtimeStart && item.downtimeEnd) details = `<div class="item-details"><span class="detail-badge"><i class="fas fa-clock"></i> ${this.formatDuration(new Date(item.downtimeEnd) - new Date(item.downtimeStart))}</span></div>`;
                break;
            case 'parts':
                icon = `<div class="item-icon bg-grey"><i class="fas fa-box"></i></div>`;
                title = item.name; subtitle = `Réf: ${item.reference || 'N/A'}`;
                const stock = Number(item.quantity);
                const minStock = Number(item.minQuantity);
                const stockClass = stock <= minStock ? 'status-low-stock' : 'status-planned';
                actions = `<div class="item-actions">
                    <span class="status-badge status-info">Fourn: ${item.supplier || '--'}</span>
                    <span class="status-badge status-info">Délai: ${item.delaiLivraison || '--'}j</span>
                    <span class="status-badge status-info">Min: ${minStock}</span>
                    <span class="status-badge ${stockClass}">Stock: ${stock}</span>
                    <i class="fas fa-edit" onclick="event.stopPropagation(); GMAOApp.openForm('parts', '${item.id}')"></i>
                </div>`;
                break;
            case 'technicians':
                icon = `<div class="item-icon bg-green"><i class="fas fa-user-cog"></i></div>`;
                title = item.name; subtitle = item.specialty;
                actions = `<i class="fas fa-edit" onclick="event.stopPropagation(); GMAOApp.openForm('technicians', '${item.id}')"></i>`;
                break;
        }
        return `<li class="list-item ${clickableClass}" data-type="${type}" data-id="${item.id}">${icon}<div class="item-info"><div class="item-title">${title}</div><div class="item-subtitle">${subtitle}</div>${details}</div><div class="item-actions">${actions}</div></li>`;
    },
    calculateAndDisplayKPIs(correctiveCompleted) {
        let totalDowntime = correctiveCompleted.reduce((acc, i) => acc + (new Date(i.downtimeEnd) - new Date(i.downtimeStart)), 0);
        let totalUptime = 0;
        if (correctiveCompleted.length > 1) { for (let i = 1; i < correctiveCompleted.length; i++) { const uptime = new Date(correctiveCompleted[i].downtimeStart) - new Date(correctiveCompleted[i - 1].downtimeEnd); if (uptime > 0) totalUptime += uptime; } }
        const availability = (totalUptime + totalDowntime) > 0 ? (totalUptime / (totalUptime + totalDowntime)) * 100 : 100;
        
        document.getElementById('kpi-availability-value').textContent = `${availability.toFixed(1)}%`;
        this.createChart('availabilityChart', 'doughnut', {
            datasets: [{
                data: [availability, 100 - availability],
                backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--secondary-color'), getComputedStyle(document.documentElement).getPropertyValue('--border-color')],
                borderWidth: 0,
                cutout: '70%'
            }]
        }, { plugins: { tooltip: { enabled: false } } });

        document.getElementById('kpi-mttr').textContent = this.formatDuration(correctiveCompleted.length > 0 ? totalDowntime / correctiveCompleted.length : 0);
        document.getElementById('kpi-mtbf').textContent = this.formatDuration(correctiveCompleted.length > 1 ? totalUptime / (correctiveCompleted.length - 1) : 0, true);
    },
    renderAnalysisCharts(allFilteredInterventions) {
        const msToHours = ms => ms / 3600000;
        const interventionsWithDuration = allFilteredInterventions.filter(i => i.status === 'completed' && i.downtimeStart && i.downtimeEnd);
        
        const downtimeByMachine = interventionsWithDuration.reduce((acc, i) => {
            const eq = this.data.equipments.find(e => e.id === i.eqId);
            if(eq) {
                acc[eq.name] = (acc[eq.name] || 0) + (new Date(i.downtimeEnd) - new Date(i.downtimeStart));
            }
            return acc;
        }, {});

        const sortedMachines = Object.entries(downtimeByMachine).sort((a, b) => b[1] - a[1]).slice(0, 3);
        const machineLabels = sortedMachines.map(entry => entry[0]);
        const machineData = sortedMachines.map(entry => msToHours(entry[1]));

        this.createChart('downtimeByMachineChart', 'bar', { labels: machineLabels, datasets: [{ label: "Heures d'arrêt", data: machineData, backgroundColor: '#D0021B' }] }, { indexAxis: 'y', plugins: { legend: { display: false } } });
    },
    createChart(canvasId, type, data, options = {}) {
        if(!document.getElementById(canvasId)) return;
        if (this.charts[canvasId]) this.charts[canvasId].destroy();
        const ctx = document.getElementById(canvasId).getContext('2d');
        this.charts[canvasId] = new Chart(ctx, { type, data, options: { responsive: true, ...options } });
    },
    navigateTo(hash) {
        const newHash = hash || '#dashboard';
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        document.querySelector(newHash).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => { n.classList.toggle('active', n.getAttribute('href') === newHash); });
        window.location.hash = newHash;
        this.renderCurrentPage();
    },
    openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    },
    openForm(type, id = null) {
        const form = document.getElementById('mainForm');
        const modalTitle = document.getElementById('modalTitle');
        let html = '', title = '', item = null;
        const eqOptions = this.data.equipments.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        const techOptions = this.data.technicians.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        
        switch (type) {
            case 'interventions':
                item = id ? this.data.interventions.find(i => i.id === id) : {};
                title = id ? 'Modifier Intervention' : 'Nouvelle Intervention';
                html = `<input type="hidden" name="id" value="${item.id || ''}"><div class="form-group"><label>Description</label><input type="text" name="desc" class="form-control" value="${item.desc || ''}" required></div><div class="form-group"><label>Date</label><input type="date" name="date" class="form-control" value="${item.date || new Date().toISOString().slice(0,10)}" required></div><div class="form-group"><label>Type</label><select name="type" class="form-control"><option value="Préventive">Préventive</option><option value="Corrective">Corrective</option></select></div><div class="form-group"><label>Statut</label><select name="status" class="form-control"><option value="planned">planned</option><option value="progress">progress</option><option value="completed">completed</option></select></div><div class="form-group"><label>Équipement</label><select name="eqId" class="form-control">${eqOptions}</select></div><div class="form-group"><label>Technicien</label><select name="techId" class="form-control">${techOptions}</select></div>
                <div class="form-group"><label>Pièces utilisées</label><div id="used-parts-container"></div><input type="text" id="part-search-input" class="form-control" placeholder="Rechercher une pièce..."><div class="parts-search-results" id="parts-search-results"></div></div>
                <hr style="border: 1px solid var(--border-color); margin: 20px 0;"><div class="form-group"><label>Début intervention</label><input type="datetime-local" name="downtimeStart" class="form-control" value="${item.downtimeStart || ''}"></div><div class="form-group"><label>Fin intervention</label><input type="datetime-local" name="downtimeEnd" class="form-control" value="${item.downtimeEnd || ''}"></div>`;
                break;
            case 'parts':
                item = id ? this.data.parts.find(p => p.id === id) : {};
                title = id ? 'Modifier Pièce' : 'Nouvelle Pièce';
                html = `<input type="hidden" name="id" value="${item.id || ''}"><div class="form-group"><label>Nom</label><input type="text" name="name" class="form-control" value="${item.name || ''}" required></div><div class="form-group"><label>Référence</label><input type="text" name="reference" class="form-control" value="${item.reference || ''}"></div><div class="form-group"><label>Fournisseur</label><input type="text" name="supplier" class="form-control" value="${item.supplier || ''}"></div><div class="form-group"><label>Prix Unitaire (HT)</label><input type="number" step="0.01" name="unitPrice" class="form-control" value="${item.unitPrice || 0}"></div><div class="form-group"><label>Quantité</label><input type="number" name="quantity" class="form-control" value="${item.quantity || 0}" required ${id ? 'readonly' : ''}></div><div class="form-group"><label>Quantité Minimum</label><input type="number" name="minQuantity" class="form-control" value="${item.minQuantity || 0}" required></div><div class="form-group"><label>Délai Livraison (jours)</label><input type="number" name="delaiLivraison" class="form-control" value="${item.delaiLivraison || 0}"></div>`;
                break;
            default:
                const typeLabels = { equipments: 'Équipement', technicians: 'Technicien' };
                title = id ? `Modifier ${typeLabels[type]}` : `Nouveau ${typeLabels[type]}`;
                item = id ? this.data[type].find(e => e.id === id) : {};
                const fields = { equipments: [{label: 'Nom', name: 'name'}, {label: 'Localisation', name: 'location'}], technicians: [{label: 'Nom', name: 'name'}, {label: 'Spécialité', name: 'specialty'}] };
                html = `<input type="hidden" name="id" value="${item.id || ''}">`;
                fields[type].forEach(field => { html += `<div class="form-group"><label>${field.label}</label><input type="text" name="${field.name}" class="form-control" value="${item[field.name] || ''}" required></div>`; });
                break;
        }
        form.innerHTML = html + `<button type="submit" class="btn btn-full">Enregistrer</button>${id ? `<button type="button" class="btn btn-full btn-danger" style="margin-top:10px;" onclick="GMAOApp.deleteItem('${type}', '${id}')">Supprimer</button>` : ''}`;
        
        if(id){ 
            Object.keys(item).forEach(key => { if(form.elements[key]) form.elements[key].value = item[key]; });
            if (type === 'interventions' && item.partsUsed) {
                this.prefillUsedParts(item.partsUsed);
            }
        }
        if (type === 'interventions') this.setupPartSearch();
        
        modalTitle.textContent = title;
        form.dataset.type = type;
        this.openModal('formModal');
    },
    showTechnicianStats(id) {
        const technicien = this.data.technicians.find(t => t.id === id); if (!technicien) return;
        const interventionsFiltrees = this.getFilteredInterventions(this.dashboardFilters);
        const techInterventions = interventionsFiltrees.filter(i => i.techId === id && (i.type === 'Corrective' || i.type === 'Préventive') && i.status === 'completed' && i.downtimeStart && i.downtimeEnd);
        const totalWorkTime = techInterventions.reduce((acc, i) => acc + (new Date(i.downtimeEnd) - new Date(i.downtimeStart)), 0);
        const uniqueWorkDays = new Set(techInterventions.map(i => i.date)).size;
        const workdayInMillis = (8 * 60 - 45) * 60 * 1000;
        const totalWorkableTime = uniqueWorkDays * workdayInMillis;
        const workloadPercentage = totalWorkableTime > 0 ? (totalWorkTime / totalWorkableTime) * 100 : 0;
        document.getElementById('statsModalTitle').textContent = `Stats de ${technicien.name}`;
        document.getElementById('statsTotalTime').textContent = this.formatDuration(totalWorkTime, true);
        document.getElementById('statsWorkload').textContent = `${workloadPercentage.toFixed(1)}%`;
        this.openModal('statsModal');
    },
    showEquipmentDetails(id) {
        const equipment = this.data.equipments.find(e => e.id === id); if (!equipment) return;
        document.getElementById('equipmentDetailModalTitle').textContent = `Détails pour ${equipment.name}`;
        const contentEl = document.getElementById('equipmentDetailContent');
        contentEl.innerHTML = `
            <div class="date-filter-grid">
                <div class="form-group" style="margin:0;"><label>Début</label><input type="date" id="equip-detail-start" class="form-control"></div>
                <div class="form-group" style="margin:0;"><label>Fin</label><input type="date" id="equip-detail-end" class="form-control"></div>
            </div>
            <h4 style="margin-top: 20px;">Temps d'arrêt total</h4>
            <p id="equip-detail-downtime">--</p>
            <h4 style="margin-top: 20px;">Pièces consommées</h4>
            <div id="equip-detail-parts"></div>
        `;

        const calculateDetails = () => {
            const startDate = document.getElementById('equip-detail-start').value;
            const endDate = document.getElementById('equip-detail-end').value;
            
            const relevantInterventions = this.data.interventions.filter(i => {
                if (i.eqId !== id || i.status !== 'completed') return false;
                const iDate = new Date(i.date);
                const start = startDate ? new Date(startDate) : null;
                const end = endDate ? new Date(endDate) : null;
                if (start && iDate < start) return false;
                if (end) { end.setHours(23, 59, 59, 999); if (iDate > end) return false; }
                return true;
            });

            const totalDowntime = relevantInterventions.reduce((total, i) => {
                if (i.downtimeStart && i.downtimeEnd) {
                    return total + (new Date(i.downtimeEnd) - new Date(i.downtimeStart));
                }
                return total;
            }, 0);
            document.getElementById('equip-detail-downtime').textContent = this.formatDuration(totalDowntime, true);

            const partsListEl = document.getElementById('equip-detail-parts');
            let tableHTML = '<table class="detail-table"><tr><th>Date</th><th>OT</th><th>Pièce</th><th>Qté</th></tr>';
            let partsFound = false;
            relevantInterventions.forEach(i => {
                if(i.partsUsed && Object.keys(i.partsUsed).length > 0) {
                    partsFound = true;
                    for (const partId in i.partsUsed) {
                        const part = this.data.parts.find(p => p.id === partId);
                        tableHTML += `<tr><td>${new Date(i.date).toLocaleDateString()}</td><td>${i.otNumber || '--'}</td><td>${part ? part.name : 'N/A'}</td><td>${i.partsUsed[partId]}</td></tr>`;
                    }
                }
            });
            tableHTML += '</table>';
            partsListEl.innerHTML = partsFound ? tableHTML : '<p>Aucune pièce consommée sur cette période.</p>';
        };

        document.getElementById('equip-detail-start').onchange = calculateDetails;
        document.getElementById('equip-detail-end').onchange = calculateDetails;
        calculateDetails();
        this.openModal('equipmentDetailModal');
    },
    showPartDetails(id) {
        const part = this.data.parts.find(p => p.id === id); if (!part) return;
        document.getElementById('partDetailModalTitle').textContent = `Détails pour ${part.name}`;
        const contentEl = document.getElementById('partDetailContent');
        contentEl.innerHTML = `
            <div class="date-filter-grid">
                <div class="form-group" style="margin:0;"><label>Début</label><input type="date" id="part-detail-start" class="form-control"></div>
                <div class="form-group" style="margin:0;"><label>Fin</label><input type="date" id="part-detail-end" class="form-control"></div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label>Ajouter un approvisionnement</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="part-supply-qty" class="form-control" placeholder="Quantité">
                    <input type="text" id="part-supply-po" class="form-control" placeholder="N° BC">
                    <button id="add-supply-btn" class="btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <h4 style="margin-top: 20px;">Historique des mouvements</h4>
            <div id="part-detail-history"></div>
        `;

        const calculateDetails = () => {
            const startDate = document.getElementById('part-detail-start').value;
            const endDate = document.getElementById('part-detail-end').value;

            const consumptions = this.data.interventions
                .filter(i => {
                    if (!i.partsUsed || !i.partsUsed[id] || i.status !== 'completed') return false;
                    const iDate = new Date(i.date);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (start && iDate < start) return false;
                    if (end) { end.setHours(23, 59, 59, 999); if (iDate > end) return false; }
                    return true;
                })
                .map(i => ({
                    date: i.date,
                    type: 'Consommation',
                    quantity: `-${i.partsUsed[id]}`,
                    details: `${i.otNumber || 'N/A'} sur ${this.data.equipments.find(e => e.id === i.eqId)?.name || 'N/A'}`
                }));
            
            const supplies = (part.history || [])
                .filter(h => {
                    if (h.type !== 'approvisionnement') return false;
                     const hDate = new Date(h.date);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (start && hDate < start) return false;
                    if (end) { end.setHours(23, 59, 59, 999); if (hDate > end) return false; }
                    return true;
                })
                .map(h => ({ ...h, quantity: `+${h.quantity}` }));

            const history = [...consumptions, ...supplies].sort((a,b) => new Date(b.date) - new Date(a.date));

            const historyEl = document.getElementById('part-detail-history');
            if (history.length === 0) {
                historyEl.innerHTML = '<p>Aucun mouvement sur cette période.</p>';
            } else {
                let tableHTML = '<table class="detail-table"><tr><th>Date</th><th>Type</th><th>Détails</th><th>Qté</th></tr>';
                history.forEach(h => {
                    tableHTML += `<tr><td>${new Date(h.date).toLocaleDateString()}</td><td>${h.type}</td><td>${h.details}</td><td>${h.quantity}</td></tr>`;
                });
                tableHTML += '</table>';
                historyEl.innerHTML = tableHTML;
            }
        };

        document.getElementById('add-supply-btn').addEventListener('click', async () => {
            const qty = parseInt(document.getElementById('part-supply-qty').value, 10);
            const poNumber = document.getElementById('part-supply-po').value;
            if (qty > 0) {
                const { doc, runTransaction } = window.firebase;
                const partRef = doc(window.db, `users/${this.currentUser.uid}/parts`, id);
                try {
                    await runTransaction(window.db, async (transaction) => {
                        const partDoc = await transaction.get(partRef);
                        if (partDoc.exists()) {
                            const newQuantity = Number(partDoc.data().quantity) + qty;
                            const newHistory = partDoc.data().history || [];
                            newHistory.push({
                                date: new Date().toISOString().slice(0,10),
                                type: 'approvisionnement',
                                quantity: qty,
                                details: `BC: ${poNumber}`
                            });
                            transaction.update(partRef, { quantity: newQuantity, history: newHistory });
                        }
                    });
                    document.getElementById('part-supply-qty').value = '';
                    document.getElementById('part-supply-po').value = '';
                } catch (e) {
                    alert("Erreur lors de l'ajout de l'approvisionnement.");
                }
            }
        });

        document.getElementById('part-detail-start').onchange = calculateDetails;
        document.getElementById('part-detail-end').onchange = calculateDetails;
        calculateDetails();
        this.openModal('partDetailModal');
    },
    openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    },
    closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); },
    showQRCode(id) {
        const eq = this.data.equipments.find(e => e.id === id); if(!eq) return;
        const qrContainer = document.getElementById('qrCodeCanvas'); qrContainer.innerHTML = '';
        document.getElementById('qrEquipmentName').textContent = eq.name;
        new QRCode(qrContainer, { text: `gmao://equipment/${eq.id}`, width: 200, height: 200 });
        this.openModal('qrModal');
    },
    toggleTheme() { const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark'; this.applyTheme(newTheme); localStorage.setItem('gmao-theme', newTheme); },
    applyTheme(theme) {
        const icon = document.querySelector('.theme-switcher');
        if (theme === 'dark') { document.body.classList.add('dark-mode'); icon.classList.replace('fa-moon', 'fa-sun'); } 
        else { document.body.classList.remove('dark-mode'); icon.classList.replace('fa-sun', 'fa-moon'); }
    },
    formatDuration(ms, long = false) {
        if (ms <= 0 || !ms) return long ? "0j 0h 0m" : "0m";
        const days = Math.floor(ms / 86400000); const hours = Math.floor((ms % 86400000) / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        if (long) return `${days}j ${hours}h ${minutes}m`;
        let result = '';
        if (days > 0) result += `${days}j `; if (hours > 0) result += `${hours}h `;
        result += `${minutes}m`; return result.trim() || "0m";
    },
    setupEventListeners() {
        document.getElementById('logout-btn').addEventListener('click', () => {
            const { signOut } = window.firebase;
            signOut(window.auth);
        });
        document.getElementById('whatsapp-btn').addEventListener('click', () => this.openModal('whatsappModal'));
        window.addEventListener('hashchange', () => this.navigateTo(window.location.hash));
        document.querySelector('.bottom-nav').addEventListener('click', e => { const navItem = e.target.closest('.nav-item'); if (navItem) { e.preventDefault(); this.navigateTo(navItem.getAttribute('href')); } });
        document.getElementById('fab-add-button').addEventListener('click', () => { const page = (window.location.hash || '#dashboard').substring(1); if (page !== 'dashboard' && page !== '') this.openForm(page); });
        document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', e => { if (e.target === modal || e.target.classList.contains('close-modal')) this.closeModal(modal.id); }); });
        document.getElementById('mainForm').addEventListener('submit', this.handleSubmit.bind(this));
        document.querySelector('.theme-switcher').addEventListener('click', this.toggleTheme.bind(this));
        document.querySelector('.app-container').addEventListener('click', e => {
            const listItem = e.target.closest('.list-item-clickable'); if (!listItem) return;
            const type = listItem.dataset.type; const id = listItem.dataset.id;
            switch(type) {
                case 'technicians': this.showTechnicianStats(id); break;
                case 'equipments': this.showEquipmentDetails(id); break;
                case 'parts': this.showPartDetails(id); break;
                default: this.openForm(type, id); break;
            }
        });
    },

    setupPartSearch() {
        const searchInput = document.getElementById('part-search-input');
        const searchResults = document.getElementById('parts-search-results');
        
        searchInput.addEventListener('input', () => {
            const term = searchInput.value.toLowerCase();
            if (term.length < 2) {
                searchResults.innerHTML = '';
                return;
            }
            const results = this.data.parts.filter(p => p.name.toLowerCase().includes(term) || (p.reference && p.reference.toLowerCase().includes(term)));
            searchResults.innerHTML = results.map(p => `<div data-part-id="${p.id}">${p.name} - Réf: ${p.reference || 'N/A'}</div>`).join('');
        });

        searchResults.addEventListener('click', e => {
            if (e.target.dataset.partId) {
                const partId = e.target.dataset.partId;
                const part = this.data.parts.find(p => p.id === partId);
                this.addPartToUsedList(part);
                searchInput.value = '';
                searchResults.innerHTML = '';
            }
        });
    },

    addPartToUsedList(part, quantity = 1) {
        const container = document.getElementById('used-parts-container');
        if (container.querySelector(`[data-part-id="${part.id}"]`)) return; // Evite les doublons

        const item = document.createElement('div');
        item.className = 'used-part-item';
        item.dataset.partId = part.id;
        item.innerHTML = `
            <span>${part.name}</span>
            <input type="number" class="form-control" value="${quantity}" min="1">
            <button type="button" class="remove-part-btn"><i class="fas fa-times-circle"></i></button>
        `;
        item.querySelector('.remove-part-btn').addEventListener('click', () => item.remove());
        container.appendChild(item);
    },

    prefillUsedParts(partsUsed) {
        if (!partsUsed) return;
        for (const partId in partsUsed) {
            const part = this.data.parts.find(p => p.id === partId);
            if (part) {
                this.addPartToUsedList(part, partsUsed[partId]);
            }
        }
    },
    
    updateLowStockNotification() {
        const needsReorder = this.data.parts.some(p => Number(p.quantity) <= Number(p.minQuantity));
        document.querySelector('.nav-item[href="#parts"] .notification-dot').style.display = needsReorder ? 'block' : 'none';
    },

    async addTestData() {
        if (!this.currentUser) return alert("Vous devez être connecté pour ajouter des données.");
        const { writeBatch, doc, collection } = window.firebase;
        const batch = writeBatch(window.db);
        const basePath = `users/${this.currentUser.uid}`;
        const testData = {
            equipments: [ { name: "Presse Hydraulique P1", location: "Atelier A" }, { name: "Robot de soudure R2", location: "Ligne 3" } ],
            technicians: [ { name: "Jean Dupont", specialty: "Mécanique" }, { name: "Amina El Fassi", specialty: "Électronique" } ],
            parts: [ { name: "Filtre à huile H-123", reference: "F-5540", supplier: "Fournisseur A", quantity: 12, minQuantity: 5, delaiLivraison: 3, unitPrice: 150.50 }, { name: "Roulement 6204-2RS", reference: "R-6204", supplier: "Fournisseur B", quantity: 3, minQuantity: 4, delaiLivraison: 7, unitPrice: 80 } ],
            interventions: [
                { otNumber: `OT-${Date.now() + 1}`, desc: "Panne moteur (test)", type: "Corrective", date: "2025-08-15", status: "completed", downtimeStart: "2025-08-15T08:00", downtimeEnd: "2025-08-15T10:30" },
                { otNumber: `OT-${Date.now() + 2}`, desc: "Contrôle préventif (test)", type: "Préventive", date: "2025-08-20", status: "completed", downtimeStart: "2025-08-20T09:00", downtimeEnd: "2025-08-20T10:00" },
            ]
        };
        try {
            const eqRefs = testData.equipments.map(data => { const ref = doc(collection(window.db, basePath, "equipments")); batch.set(ref, data); return ref; });
            const techRefs = testData.technicians.map(data => { const ref = doc(collection(window.db, basePath, "technicians")); batch.set(ref, data); return ref; });
            testData.parts.forEach(data => { const ref = doc(collection(window.db, basePath, "parts")); batch.set(ref, data); });
            
            const int1 = testData.interventions[0]; int1.eqId = eqRefs[0].id; int1.techId = techRefs[0].id;
            batch.set(doc(collection(window.db, basePath, "interventions")), int1);
            const int2 = testData.interventions[1]; int2.eqId = eqRefs[0].id; int2.techId = techRefs[0].id;
            batch.set(doc(collection(window.db, basePath, "interventions")), int2);
            await batch.commit();
            alert("Données de test ajoutées avec succès !");
        } catch (e) { console.error("Erreur ajout données: ", e); alert("Erreur lors de l'ajout des données."); }
    }
};

window.GMAOApp = GMAOApp;

</script>
</body>
</html>
